version: '3.8'

# --- REDES ---
networks:
  erp-network:
    driver: bridge

# --- VOLUMENES ---
volumes:
  auth_db_data:
  finance_db_data:
  inventory_db_data:
  crm_db_data:
  hhrr_db_data:
  accounting_db_data:
  project_db_data:
  rabbitmq_data:

services:
  # =========================================
  # INFRAESTRUCTURA CORE
  # =========================================
  
  traefik:
    image: traefik:v2.10
    command: --api.insecure=false --providers.docker # api.insecure=false en prod
    ports:
      - "80:80"
      - "443:443" # Comenta el dashboard inseguro en producciÃ³n
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - erp-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    expose:
      - "5672"
    environment:
      - RABBITMQ_ERLANG_COOKIE=${RABBITMQ_ERLANG_COOKIE}
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - erp-network
    healthcheck:
        test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
        interval: 10s
        timeout: 10s
        retries: 5

  # =========================================
  # SERVICIO: FRONTEND (Modo Desarrollo)
  # =========================================
  frontend:
    build: 
      context: ./erp-frontend
      dockerfile: Dockerfile.dev
    restart: always
    ports:
      - "4200:4200"
    volumes:
      - ./erp-frontend:/app
      - /app/node_modules
    networks:
      - erp-network
    environment:
      - NODE_ENV=development
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=4200"

  # =========================================
  # SERVICIO: AUTH
  # =========================================
  auth_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=auth_db
      - TZ=${TZ}
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    restart: always
    volumes:
      - ./services/auth-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000" # Quitamos --reload para prod
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@auth_db:5432/auth_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - TZ=${TZ}
    depends_on:
      auth_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.services.auth.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-strip"

  # =========================================
  # SERVICIO: FINANCE
  # =========================================
  finance_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=finance_db
      - TZ=${TZ}
    volumes:
      - finance_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d finance_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  finance-service:
    build:
      context: .
      dockerfile: services/finance-service/Dockerfile
    restart: always
    volumes:
      - ./services/finance-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@finance_db:5432/finance_db
      - FINANCE_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@finance_db:5432/finance_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/%2F
      - TZ=${TZ}
    depends_on:
      finance_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.finance.rule=PathPrefix(`/api/finance`)"
      - "traefik.http.services.finance.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.finance-strip.stripprefix.prefixes=/api/finance"
      - "traefik.http.routers.finance.middlewares=finance-strip"

  # =========================================
  # SERVICIO: INVENTORY
  # =========================================
  inventory_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=inventory_db
      - TZ=${TZ}
    volumes:
      - inventory_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d inventory_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  inventory-service:
    build: 
      context: .
      dockerfile: services/inventory-service/Dockerfile
    restart: always
    volumes:
      - ./services/inventory-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@inventory_db:5432/inventory_db
      - INVENTORY_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@inventory_db:5432/inventory_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - TZ=${TZ}
    depends_on:
      inventory_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.inventory.rule=PathPrefix(`/api/inventory`)"
      - "traefik.http.services.inventory.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.inventory-strip.stripprefix.prefixes=/api/inventory"
      - "traefik.http.routers.inventory.middlewares=inventory-strip"

  inventory-worker:
    build:
      context: .
      dockerfile: services/inventory-service/Dockerfile
    command: python -u app/worker.py
    restart: always
    volumes:
      - ./services/inventory-service:/app
    environment:
      - INVENTORY_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@inventory_db:5432/inventory_db
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@inventory_db:5432/inventory_db
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/%2F
      - TZ=${TZ}
    depends_on:
      inventory_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network

  # =========================================
  # SERVICIO: CRM
  # =========================================
  crm_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=crm_db
      - TZ=${TZ}
    volumes:
      - crm_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d crm_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  crm-service:
    build:
      context: .
      dockerfile: services/crm-service/Dockerfile
    restart: always
    volumes:
      - ./services/crm-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@crm_db:5432/crm_db
      - CRM_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@crm_db:5432/crm_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - TZ=${TZ}
    depends_on:
      crm_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.crm.rule=PathPrefix(`/api/crm`)"
      - "traefik.http.services.crm.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.crm-strip.stripprefix.prefixes=/api/crm"
      - "traefik.http.routers.crm.middlewares=crm-strip"

  # =========================================
  # SERVICIO: HHRR
  # =========================================
  hhrr_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=hhrr_db
      - TZ=${TZ}
    volumes:
      - hhrr_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d hhrr_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  hhrr-service:
    build:
      context: .
      dockerfile: services/hhrr-service/Dockerfile
    restart: always
    volumes:
      - ./services/hhrr-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@hhrr_db:5432/hhrr_db
      - HHRR_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@hhrr_db:5432/hhrr_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/%2F
      - TZ=${TZ}
    depends_on:
      hhrr_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hhrr.rule=PathPrefix(`/api/hhrr`)"
      - "traefik.http.services.hhrr.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.hhrr-strip.stripprefix.prefixes=/api/hhrr"
      - "traefik.http.routers.hhrr.middlewares=hhrr-strip"

  # =========================================
  # SERVICIO: ACCOUNTING
  # =========================================
  accounting_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=accounting_db
      - TZ=${TZ}
    volumes:
      - accounting_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d accounting_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  accounting-service:
    build:
      context: .
      dockerfile: services/accounting-service/Dockerfile
    restart: always
    volumes:
      - ./services/accounting-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@accounting_db:5432/accounting_db
      - ACCOUNTING_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@accounting_db:5432/accounting_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - TZ=${TZ}
    depends_on:
      accounting_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.accounting.rule=PathPrefix(`/api/accounting`)"
      - "traefik.http.services.accounting.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.accounting-strip.stripprefix.prefixes=/api/accounting"
      - "traefik.http.routers.accounting.middlewares=accounting-strip"

  accounting-worker:
    build:
      context: .
      dockerfile: services/accounting-service/Dockerfile
    command: python -m app.worker
    restart: always
    volumes:
      - ./services/accounting-service:/app
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@accounting_db:5432/accounting_db
      - ACCOUNTING_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@accounting_db:5432/accounting_db
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/%2F
      - TZ=${TZ}
    depends_on:
      accounting_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network

  # =========================================
  # SERVICIO: PROJECTS
  # =========================================
  project_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=project_db
      - TZ=${TZ}
    volumes:
      - project_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d project_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  project-service:
    build: 
      context: .
      dockerfile: services/project-service/Dockerfile
    restart: always
    volumes:
      - ./services/project-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@project_db:5432/project_db
      - PROJECT_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@project_db:5432/project_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - TZ=${TZ}
    depends_on:
      project_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.projects.rule=PathPrefix(`/api/projects`)"
      - "traefik.http.services.projects.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.projects-strip.stripprefix.prefixes=/api/projects"
      - "traefik.http.routers.projects.middlewares=projects-strip"

  # =========================================
  # SERVICIO: COMPLIANCE
  # =========================================
  compliance-worker:
    build:
      context: .
      dockerfile: services/compliance-service/Dockerfile
    command: python -u app/worker.py
    restart: always
    volumes:
      - ./services/compliance-service:/app
    environment:
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/%2F
      - TZ=${TZ}
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network