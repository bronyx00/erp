version: '3.8'

# --- REDES ---
networks:
  erp-network:
    driver: bridge

# --- VOLUMENES (Persistencia de Datos) ---
volumes:
  auth_db_data:
  finance_db_data:
  inventory_db_data:
  crm_db_data:
  hhrr_db_data:
  accounting_db_data:
  project_db_data:
  rabbitmq_data:

services:
  # =========================================
  # INFRAESTRUCTURA CORE
  # =========================================
  
  traefik:
    image: traefik:v2.10
    command: --api.insecure=true --providers.docker
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - erp-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "15672:15672"
      - "5672:5672"
    environment:
      - RABBITMQ_ERLANG_COOKIE=secret_cookie_erp_system
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - erp-network
    healthcheck:
        test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
        interval: 10s
        timeout: 10s
        retries: 5

  # =========================================
  # SERVICIO: FRONTEND (Angular)
  # =========================================
  frontend:
    build: 
      context: ./erp-frontend
      dockerfile: Dockerfile
    restart: always
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

  # =========================================
  # SERVICIO: AUTH (Autenticación)
  # =========================================
  auth_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=auth_db
      - TZ=America/Caracas
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  auth-service:
    build: ./services/auth-service
    restart: always
    # Sincroniza la carpeta local con el contenedor
    volumes:
      - ./services/auth-service:/app
    # Intenta migrar DB al iniciar, luego arranca la app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - DATABASE_URL=postgresql+asyncpg://admin:admin@auth_db:5432/auth_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - TZ=America/Caracas
    depends_on:
      auth_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.services.auth.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-strip"

  # =========================================
  # SERVICIO: FINANCE (Finanzas)
  # =========================================
  finance_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=finance_db
      - TZ=America/Caracas
    volumes:
      - finance_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d finance_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  finance-service:
    build: ./services/finance-service
    restart: always
    volumes:
      - ./services/finance-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - FINANCE_DATABASE_URL=postgresql+asyncpg://admin:admin@finance_db:5432/finance_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@finance_db:5432/finance_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/%2F
      - TZ=America/Caracas
    depends_on:
      finance_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.finance.rule=PathPrefix(`/api/finance`)"
      - "traefik.http.services.finance.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.finance-strip.stripprefix.prefixes=/api/finance"
      - "traefik.http.routers.finance.middlewares=finance-strip"

  # =========================================
  # SERVICIO: INVENTORY (Inventario)
  # =========================================
  inventory_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=inventory_db
      - TZ=America/Caracas
    volumes:
      - inventory_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d inventory_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  inventory-service:
    build: ./services/inventory-service
    restart: always
    volumes:
      - ./services/inventory-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - INVENTORY_DATABASE_URL=postgresql+asyncpg://admin:admin@inventory_db:5432/inventory_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@inventory_db:5432/inventory_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - TZ=America/Caracas
    depends_on:
      inventory_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.inventory.rule=PathPrefix(`/api/inventory`)"
      - "traefik.http.services.inventory.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.inventory-strip.stripprefix.prefixes=/api/inventory"
      - "traefik.http.routers.inventory.middlewares=inventory-strip"

  inventory-worker:
    build: ./services/inventory-service
    # Worker no necesita migrar, solo el servicio principal
    command: python -u app/worker.py
    restart: always
    volumes:
      - ./services/inventory-service:/app
    environment:
      - INVENTORY_DATABASE_URL=postgresql+asyncpg://admin:admin@inventory_db:5432/inventory_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@inventory_db:5432/inventory_db
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/%2F
      - TZ=America/Caracas
    depends_on:
      inventory_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network

  # =========================================
  # SERVICIO: CRM (Clientes)
  # =========================================
  crm_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=crm_db
      - TZ=America/Caracas
    volumes:
      - crm_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d crm_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  crm-service:
    build: ./services/crm-service
    restart: always
    volumes:
      - ./services/crm-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - CRM_DATABASE_URL=postgresql+asyncpg://admin:admin@crm_db:5432/crm_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@crm_db:5432/crm_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - TZ=America/Caracas
    depends_on:
      crm_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.crm.rule=PathPrefix(`/api/crm`)"
      - "traefik.http.services.crm.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.crm-strip.stripprefix.prefixes=/api/crm"
      - "traefik.http.routers.crm.middlewares=crm-strip"

  # =========================================
  # SERVICIO: HHRR (Recursos Humanos)
  # =========================================
  hhrr_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=hhrr_db
      - TZ=America/Caracas
    volumes:
      - hhrr_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d hhrr_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  hhrr-service:
    build: ./services/hhrr-service
    restart: always
    volumes:
      - ./services/hhrr-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - HHRR_DATABASE_URL=postgresql+asyncpg://admin:admin@hhrr_db:5432/hhrr_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@hhrr_db:5432/hhrr_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/%2F
      - TZ=America/Caracas
    depends_on:
      hhrr_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hhrr.rule=PathPrefix(`/api/hhrr`)"
      - "traefik.http.services.hhrr.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.hhrr-strip.stripprefix.prefixes=/api/hhrr"
      - "traefik.http.routers.hhrr.middlewares=hhrr-strip"

  # =========================================
  # SERVICIO: ACCOUNTING (Contabilidad)
  # =========================================
  accounting_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=accounting_db
      - TZ=America/Caracas
    volumes:
      - accounting_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d accounting_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  accounting-service:
    build: ./services/accounting-service
    restart: always
    volumes:
      - ./services/accounting-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - ACCOUNTING_DATABASE_URL=postgresql+asyncpg://admin:admin@accounting_db:5432/accounting_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@accounting_db:5432/accounting_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - TZ=America/Caracas
    depends_on:
      accounting_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.accounting.rule=PathPrefix(`/api/accounting`)"
      - "traefik.http.services.accounting.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.accounting-strip.stripprefix.prefixes=/api/accounting"
      - "traefik.http.routers.accounting.middlewares=accounting-strip"

  accounting-worker:
    build: ./services/accounting-service
    command: python -m app.worker
    restart: always
    volumes:
      - ./services/accounting-service:/app
    environment:
      - ACCOUNTING_DATABASE_URL=postgresql+asyncpg://admin:admin@accounting_db:5432/accounting_db
      - DATABASE_URL=postgresql+asyncpg://admin:admin@accounting_db:5432/accounting_db
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/%2F
      - TZ=America/Caracas
    depends_on:
      accounting_db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network

  # =========================================
  # SERVICIO: PROJECTS (Gestión de Proyectos)
  # =========================================
  project_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=project_db
      - TZ=America/Caracas
    volumes:
      - project_db_data:/var/lib/postgresql/data
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d project_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  project-service:
    build: ./services/project-service
    restart: always
    volumes:
      - ./services/project-service:/app
    command: >
      sh -c "alembic upgrade head && 
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - DATABASE_URL=postgresql+asyncpg://admin:admin@project_db:5432/project_db
      - JWT_SECRET_KEY=SECRET_SUPER_SECRETO_CAMBIAME
      - TZ=America/Caracas
    depends_on:
      project_db:
        condition: service_healthy
    networks:
      - erp-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.projects.rule=PathPrefix(`/api/projects`)"
      - "traefik.http.services.projects.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.projects-strip.stripprefix.prefixes=/api/projects"
      - "traefik.http.routers.projects.middlewares=projects-strip"

  # =========================================
  # SERVICIO: COMPLIANCE (Fiscal Worker)
  # =========================================
  compliance-worker:
    build: ./services/compliance-service
    command: python -u app/worker.py
    restart: always
    volumes:
      - ./services/compliance-service:/app
    environment:
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/%2F
      - TZ=America/Caracas
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - erp-network